<?php
/*
 * $Id: database.php,v 1.4 2009/11/25 01:45:46 jim Exp $
 *
 * $Log: database.php,v $
 * Revision 1.4  2009/11/25 01:45:46  jim
 * - Use Series instead of Model for consistency
 *
 * Revision 1.3  2009/11/23 01:06:37  jim
 * - Added function to update a car field
 * - Update record modification time for changes to user entry
 * - Update record modification time for changes to car entry
 *
 * Revision 1.2  2009/11/19 00:48:48  jim
 * *** empty log message ***
 *
 * Revision 1.2  2009/11/15 22:02:38  jim
 * Updated header information
 *
 *
 */

/**
 * Database.php
 * 
 * The Database class is meant to simplify the task of accessing
 * information from the website's database.
 *
 * Written by: Jpmaster77 a.k.a. The Grandmaster of C++ (GMC)
 * Last Updated: August 17, 2004
 */
include("include/car_database_config.php");
      
class MySQLDB
{
   var $connection;         //The MySQL database connection
   /* Note: call getNumMembers() to access $num_members! */

   /* Class constructor */
   function MySQLDB(){

      $this->connection = mysqli_connect(DB_SERVER, DB_USER, DB_PASS, DB_NAME ) or die(mysqli_error());
      
   }

   /** - TODO
    * updateCar - Inserts the given (username, password, email)
    * info into the database. Appropriate user level is set.
    * Returns true on success, false otherwise.
    */
   function updateCarField($id, $field, $value){
      $q = "UPDATE ".TBL_CARS." SET ".$field." = '$value', mtime = now() WHERE id = '$id'";
      mysqli_real_escape_string( $q );
      $result = mysqli_query( $this->connection, $q );
	  if (!$result) {
     	      $message  = '<b>Invalid query:</b><br>' . mysqli_error() . '<br><br>';
			  $message .= '<b>Whole query:</b><br>' . $q . '<br><br>';
			  die($message);
			  return $result; // Bad Insert
	  }
      return $result;
  }

   /** - TODO
    * updateCar - Inserts the given (username, password, email)
    * info into the database. Appropriate user level is set.
    * Returns true on success, false otherwise.
    */
	function updateCar($mod, $id, $year, $series, $variant, $type, $chassis, $color, $engine, $pdate, $sdate, $comment ) {
      $time = time();
      $q = "UPDATE ".TBL_CARS." SET
		year = '$year',
		series = '$series',
		variant = '$variant',
 		type = '$type',
 		chassis = '$chassis',
 		color = '$color',
 		engine = '$engine',
 		purchasedate = '$pdate',
 		solddate = '$sdate',
 		comments = '$comment',
		mtime = now(),
		ModifiedBy = '$mod'
		
		WHERE id = '$id'";

 
       mysqli_real_escape_string( $q );
      $result = mysqli_query( $this->connection, $q );
	  $id = mysqli_insert_id();
	  if (!$result) {
     	      $message  = '<b>Invalid query:</b><br>' . mysqli_error() . '<br><br>';
			  $message .= '<b>Whole query:</b><br>' . $q . '<br><br>';
			  die($message);
			  return $result; // Bad Insert
	  }
	  // Now try the image
      return $result;
   }

   /** - TODO
    * addNewCar - Inserts the given (username, password, email)
    * info into the database. Appropriate user level is set.
    * Returns true on success, false otherwise.
    */
	function addNewCar($username, $year, $series, $variant, $type, $chassis, $color, $engine, $pdate, $sdate, $comment, $image ) {
      $time = time();
      $q = "INSERT INTO ".TBL_CARS." VALUES 
      ('','$username',now(),now(),'$username','$series','$variant','$year','$type', '$chassis', '$color','$engine','$pdate','$sdate','$comment', '$image')";
       mysqli_real_escape_string( $q );
      $result = mysqli_query( $this->connection, $q );
	  $id = mysqli_insert_id();
	  if (!$result) {
     	      $message  = '<b>Invalid query:</b><br>' . mysqli_error() . '<br><br>';
			  $message .= '<b>Whole query:</b><br>' . $q . '<br><br>';
			  die($message);
			  return $result; // Bad Insert
	  }
	  // Now try the image
      return $result;
   }
   
   
   /** - TODO
    * getCarTable - Returns the result array from a mysql
    * query asking for all information stored regarding
    * the given cars for a given user id. Can return multiple rows
	* If query fails, NULL is returned.
    */
   function getCarTable($username){
      $q = "SELECT * FROM ".TBL_CARS." WHERE username = '$username'";
      $result = mysqli_query( $this->connection, $q );
      /* Error occurred, return given name by default */
      if(!$result || (mysql_numrows($result) < 1)){
         return NULL;
      }
      return $result;
   }
   
   /** 
    * GetCarInfo - Returns the result array from a mysql
    * query asking for all information stored regarding
    * the given car id. If query fails, NULL is returned.
    */
   function getCarInfo($id){
      $q = "SELECT * FROM ".TBL_CARS." WHERE id = '$id'";
      $result = mysqli_query( $this->connection, $q );
      /* Error occurred, return given name by default */
      // if(!$result || (mysql_numrows($result) < 1)){
      $cnt = $rowcount=mysqli_num_rows($result);
      if(!$result || ( $cnt < 1)){
         return NULL;
      }
      /* Return result array */
      $dbarray = mysqli_fetch_array($result);
      return $dbarray;
   }
   
   
   /** - TODO
    * query - Performs the given query on the database and
    * returns the result, which may be false, true or a
    * resource identifier.
    */
   function getInfo($q){
      mysqli_real_escape_string( $q );
      $result = mysqli_query( $this->connection, $q );
   }
};

/* Create database connection */
$cardb = new MySQLDB;

?>
